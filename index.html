<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VCV Overtone Text Decoder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #111; color: #eee; }
    canvas { margin-top: 20px; }
    h1 { margin-top: 0; }
    button { margin-top: 10px; padding: 5px 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>VCV Rack → Text Decoder</h1>
  <p>Let your phone listen to the overtones. One letter every 2 seconds.</p>
  <div id="decoded" style="font-size: 24px; margin-top: 10px;"></div>
  <button onclick="clearMessage()">Clear</button>

  <script>
    let mic, fft;
    let message = "";
    let lastDecodeTime = 0;
    const decodeInterval = 2000; // ms

    const harmonics = [130.81, 196.22, 261.63, 327.03, 392.44, 457.84, 523.25, 588.66];
    const chars = 'abcdefghijklmnopqrstuvwxyz';
    const referenceMap = {};

    // Reference mapping: a-z → 8 normalized values
    for (let i = 0; i < chars.length; i++) {
      const base = (i / 25) * 5;
      referenceMap[chars[i]] = Array.from({ length: 8 }, (_, j) => parseFloat(((base + j) % 5).toFixed(2)));
    }

    function setup() {
      createCanvas(360, 200);
      mic = new p5.AudioIn();
      mic.start();
      fft = new p5.FFT(0.9, 1024);
      fft.setInput(mic);
    }

    function draw() {
      background(20);
      fill(255);
      textAlign(CENTER);
      text('Listening for overtones...', width / 2, 20);

      const spectrum = fft.analyze();
      let amps = harmonics.map(freq => fft.getEnergy(freq));

      // Apply basic noise floor filtering
      amps = amps.map(a => (a < 10 ? 0 : a));

      // Normalize to 0–5
      let maxAmp = Math.max(...amps);
      let norm = amps.map(a => maxAmp ? parseFloat((a / maxAmp * 5).toFixed(2)) : 0);

      // Draw bars
      for (let i = 0; i < norm.length; i++) {
        fill(100 + i * 20, 200, 255);
        rect(i * 40 + 10, height - 10, 20, -norm[i] * 30);
      }

      // Decode once every 2 seconds
      if (millis() - lastDecodeTime > decodeInterval && maxAmp > 20) {
        let bestChar = '?';
        let minDiff = Infinity;
        for (let c in referenceMap) {
          let diff = 0;
          for (let i = 0; i < 8; i++) {
            diff += Math.pow(referenceMap[c][i] - norm[i], 2);
          }
          if (diff < minDiff) {
            minDiff = diff;
            bestChar = c;
          }
        }

        if (bestChar !== '?') {
          message += bestChar;
          document.getElementById('decoded').innerText = `Decoded: "${message.toUpperCase()}"`;
        }
        lastDecodeTime = millis();
      }
    }

    function clearMessage() {
      message = "";
      document.getElementById('decoded').innerText = "Decoded: \"\"";
    }
  </script>
</body>
</html>